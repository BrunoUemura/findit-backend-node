image: docker:stable

stages:
  - pre-build
  - build
  - test
  - deploy
  - notification

build-docker:
  services:
    - docker:dind
  retry: 2
  before_script:
    - docker info
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD
  stage: pre-build
  script:
    - docker build -t findit-backend-node .
    - docker tag findit-backend-node uemurabruno/findit-backend-node:latest
    - docker push uemurabruno/findit-backend-node:latest

build-project:
  image: uemurabruno/findit-backend-node:latest
  retry: 2
  services:
    - docker:dind
    - postgres:latest
  variables:
    POSTGRES_PASSWORD: postgres
    POSTGRES_USER: postgres
    POSTGRES_DB: findit
  stage: build
  tags:
    - executor-tarefas
  dependencies:
    - build-docker
  script:
    - python manage.py makemigrations
    - python manage.py migrate

test-project:
  stage: test
  image: uemurabruno/findit-backend-node:latest
  services:
    - docker:dind
    - postgres:latest
  variables:
    POSTGRES_PASSWORD: postgres
    POSTGRES_USER: postgres
    POSTGRES_DB: findit
  dependencies:
    - build-project
  tags:
    - executor-tarefas
  script:
    - echo "Hello from Test stage"
